# SE-FINAL

在进行项目之前，请先阅读该文档！！！

该文档将介绍项目逻辑、运行命令及注意事项，经过测试，按该文档的步骤进行，可以正常构建起项目并运行。

加入仓库后，第一次执行之前，请使用以下命令将项目克隆到本地。
```bash
git clone https://github.com/reisenHSI/SE-FINAL.git
```

## 项目结构
采用前后端分离进行开发，前端采用vue3框架，后端采用Django框架。运行时请使用两个终端分别运行。

vue3框架：frontend-project

Django框架：SE

## 前端

在运行vue之前，请先下载并安装node.js，官网下载即可。

运行前端项目：
```bash
cd frontend-project
npm install
npm install -D tailwindcss postcss autoprefixer
npm run dev
```
第一次运行时，请运行上面的所有命令构建项目。之后的运行，可以只执行下面的命令：
```bash
cd frontend-project
npm run dev
```

### 注意事项
如果`tailwind css`组件还不能正常运行，则继续运行下面命令
```bash
npx tailwindcss@3.4.17 init -p
```

## 后端

为了解决跨域问题,首先需要下载`django-cors-headers`包, 终端运行: 
```bash
pip install django-cors-headers -i https://pypi.tuna.tsinghua.edu.cn/simple
```

运行后端项目：
```bash
cd SE
python manage.py migrate
python manage.py runserver
```

在第一次运行时，请运行上面的完整命令。后续运行可以只执行：
```bash
cd SE
python manage.py runserver
```

### 注意事项
为避免各主机之间的数据库db.sqlite3文件冲突，在项目中设置了git不追踪该文件，已经提供了migrations文件夹（其中包含少量开发过程中的数据记录，可以删除）。在第一次拉取项目时，请按上面的命令执行，如果失败（未找到SE/db.sqlite3文件），请尝试下面的命令：
```bash
cd SE
python manage.py makemigrations app
python manage.py migrate
python manage.py runserver
```
运行成功之后，将创建数据库db.sqlite3文件，并启动服务器。

虽然设置了不追踪文件提交，但如果遇到意外情况（pull/push的时候提示dbsqlite3文件冲突），请勿上传本地文件到仓库中！！！

如果希望创建超级用户，请运行下面的命令：
```bash
python manage.py createsuperuser
```
并按照提示创建用户，之后可以进入到127.0.0.1:8000/admin访问后台。

## 项目功能说明

### 注册页面
1. 填写用户信息，年龄低于18的用户会被赋予权限为0，普通用户权限为1，工作人员权限为2（需填写邀请码ZNJJ）。
2. 这部分体现了作业要求中的权限划分与管理。

### 登陆页面
1. 输入账号密码即可。
2. 未注册的用户无法登录。
3. 体现作业要求中用户身份认证。

### 主页
主页包含已有的所有设备的元素，左方侧边栏可以进行分类，右上角包含日志和习惯管理，主模块包含设备增删和设备控制。

### 设备增删
1. 设备增加与删除，按提示填写设备信息即可。
2. 注意，此处需要工作人员才有权限进行增删。

### 设备控制
1. 点击设备上的控制按钮，进入设备控制页面。
2. 不同权限的用户具有不同的操作，如权限为0的用户无法控制洗衣机、扫地机（考虑到设备安全等），权限为1的用户基本可以执行所有操作。

### 日志
1. 点击“日志查询”按钮，进入日志查询页面。
2. 可以选择性填写筛选条件。
3. 筛选条件填写完成后，点击“查询”按钮，即可查询出符合条件的日志。
4. 只有权限大于等于1的用户才有权限进行查询。
5. 用户每次执行操作之后，都会自动生成一条日志记录，日志记录按时间由近到远的顺序展示。
6. 这部分体现了作业的日志管理功能。

### 习惯与应用
1. 点击“个人习惯”，回提供当前用户创建的所有习惯。
2. 提供创建习惯、应用习惯、删除习惯等功能。（好像是要权限大于等于1）



## 待办：
1. 添加设备时外键出错 （√ 已修复）
2. 日志查询的用户名和过滤条件的用户名冲突（√ 已修复）
3. 添加/删除设备时，返回数据的username可能存在异常（√ 已修复）
3. 注册时的用户权限初始化问题（邀请码）（前端） （√ 已修复）
4. light修改亮度等时，数据库可以修改成功，但是日志查询不到，并且给前端返回error（√ 已修复）
5. 在admin修改名字时，Device正常，但其他设备的名字也同时被更改(√ 已修复)
6. 在curtain界面，修改设备名时方框无效，需要在上方弹出的提示框中填写（前端）（√ 已修复）
7. 空调、扫地机、洗衣机前端传入username和device_name为空（前端）（√ 已修复）
8. 洗衣机设置剩余时间，后端维护开始时间，前端计算剩余时间(若为关机状态，剩余时间应该为0)
9. 扫地机设置剩余电量、已清扫面积两个参数（怎么构建？）（√ 已修复）
10. 日志查询（query_logs）前端传入username有问题，第一次进入时username为空，点击重置之后才能获取到用户名（前端） （√ 已修复）
11. 修改密码功能异常 （√ 已修复）
12. 日志查询中设备名的过滤条件有误 （√ 已修复）
13. 修改habit和robotvacuum字段，并重建数据库（后端） （√ 已修复）
14. 修改habit函数 （√ 已修复）